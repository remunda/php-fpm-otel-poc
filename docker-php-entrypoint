#!/bin/sh
set -e

# Generate PHP-FPM pool config from template with env vars
# This allows PHP_FPM_MAX_CHILDREN to be set via K8s env var
if [ -f /usr/local/etc/php-fpm.d/www.conf.template ]; then
    envsubst '${PHP_FPM_MAX_CHILDREN}' \
        < /usr/local/etc/php-fpm.d/www.conf.template \
        > /usr/local/etc/php-fpm.d/www.conf
    echo "PHP-FPM configured with pm.max_children = ${PHP_FPM_MAX_CHILDREN:-4}"
fi

# first arg is `-f` or `--some-option`
if [ "${1#-}" != "$1" ]; then
    set -- php-fpm "$@"
fi

exec "$@"
