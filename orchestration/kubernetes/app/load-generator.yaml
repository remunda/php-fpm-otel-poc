apiVersion: apps/v1
kind: Deployment
metadata:
  name: load-generator
  namespace: oteltest-local
  labels:
    app: load-generator
spec:
  replicas: 1
  selector:
    matchLabels:
      app: load-generator
  template:
    metadata:
      labels:
        app: load-generator
    spec:
      containers:
      - name: load-generator
        image: busybox:1.37
        env:
        # Interval between requests in seconds (e.g. 0.5 = 2 req/s, 0.1 = 10 req/s)
        - name: LOAD_INTERVAL
          value: "0.5"
        # Target URL
        - name: TARGET_URL
          value: "http://php-fpm:8080/api/test"
        command:
        - /bin/sh
        - -c
        - |
          echo "=== Load Generator ==="
          echo "Target: $TARGET_URL"
          echo "Interval: ${LOAD_INTERVAL}s"
          echo "========================"
          echo ""
          # Wait for the app to be ready
          echo "Waiting for app to be ready..."
          until wget -q --spider "$TARGET_URL" 2>/dev/null; do
            sleep 2
            echo "  ...waiting"
          done
          echo "App is ready! Starting load generation..."
          echo ""
          REQUEST_COUNT=0
          while true; do
            REQUEST_COUNT=$((REQUEST_COUNT + 1))
            RESPONSE=$(wget -qO- "$TARGET_URL" 2>&1) || true
            if [ $((REQUEST_COUNT % 50)) -eq 0 ]; then
              echo "[$(date '+%H:%M:%S')] Sent $REQUEST_COUNT requests"
            fi
            sleep "$LOAD_INTERVAL"
          done
        resources:
          requests:
            cpu: "10m"
            memory: "16Mi"
          limits:
            cpu: "50m"
            memory: "32Mi"
